# Python Package Management with UV

This document describes the migration from `pip` to `uv` for Python dependencies in the Shinkansen project.

## What is UV?

[UV](https://github.com/astral-sh/uv) is an extremely fast Python package installer and resolver, written in Rust. It's designed as a drop-in replacement for `pip` and `pip-tools`.

### Key Benefits

- **10-100x faster** than pip for dependency installation
- **Lockfile support** (`uv.lock`) for reproducible builds
- **Better dependency resolution** with modern algorithms
- **Compatible** with `pyproject.toml` standard (PEP 518)
- **Drop-in replacement** for pip commands
- **Polyglot consistency**: Written in Rust (matches inventory-service)

## Migration Overview

### Before (pip + requirements.txt)

```bash
# Installing dependencies
pip install -r requirements.txt

# Adding a new dependency
echo "package-name==1.0.0" >> requirements.txt
pip install -r requirements.txt

# Lock files
pip freeze > requirements.txt
```

### After (uv + pyproject.toml)

```bash
# Installing dependencies
uv sync

# Adding a new dependency
uv add package-name

# Lock files (automatic)
# uv.lock is created automatically
```

## Project Structure

```
services/analytics-worker/
├── analytics_worker/          # Python package
│   ├── __init__.py
│   └── cli.py
├── tests/                    # Test files
├── pyproject.toml            # Project configuration (replaces requirements.txt)
├── .python-version           # Python version (created by uv)
├── uv.lock                  # Dependency lockfile (created by uv)
└── .venv/                  # Virtual environment (created by uv)
```

## Common Commands

### Using Makefile (Recommended)

```bash
# Install all dependencies (from pyproject.toml)
make init-python-deps

# Add a production dependency
make uv-add PACKAGE=package-name

# Add a development dependency
make uv-add-dev PACKAGE=package-name

# Lint Python code
make lint-python

# Format Python code
make format-python

# Run Python tests
make test-python

# Run any Python command
make uv-run CMD="python script.py"
```

### Using UV Directly

```bash
# Install uv (if not already installed)
curl -LsSf https://astral.sh/uv/install.sh | sh

# Create virtual environment and install dependencies
uv sync

# Add a dependency
uv add package-name

# Add a dev dependency
uv add --dev package-name

# Run Python in virtual environment
uv run python script.py

# Run a package's CLI
uv run ruff check .

# Remove a dependency
uv remove package-name

# Update dependencies
uv lock --upgrade
```

## pyproject.toml vs requirements.txt

### pyproject.toml (New)

```toml
[project]
name = "shinkansen-analytics"
version = "0.1.0"
dependencies = [
    "grpcio>=1.60.0",
    "redis>=5.0.0",
]
```

**Advantages:**
- Standard format (PEP 518, 621)
- Includes project metadata
- Supports multiple dependency groups
- Type checking friendly
- Better editor support

### requirements.txt (Old)

```
grpcio>=1.60.0
redis>=5.0.0
```

**Disadvantages:**
- Not standardized
- No metadata
- No dependency groups
- Can become inconsistent

## Lockfiles

### uv.lock (Generated by UV)

- Contains exact versions of all dependencies
- Ensures reproducible builds across all environments
- Auto-generated and updated by UV
- Should NOT be committed to Git (see .gitignore)
- Version-specific for your Python version and OS

### Comparison with Pip

| Feature | pip | uv |
|---------|-----|----|
| Lockfiles | Requires pip-tools | Built-in |
| Performance | Base | 10-100x faster |
| Resolution | Basic | Advanced algorithms |
| pyproject.toml | Limited support | Full support |
| Dev dependencies | Manual | Built-in groups |

## Development Workflow

### Adding a New Dependency

```bash
# Step 1: Add the dependency
make uv-add PACKAGE=new-package

# Step 2: Verify installation
make uv-run CMD="python -c 'import new_package; print(new_package.__version__)'"
```

### Updating Dependencies

```bash
# Update all dependencies
uv lock --upgrade

# Update specific dependency
uv add --upgrade package-name
```

### Running Tests

```bash
# Run all tests
make test-python

# Run with coverage
cd services/analytics-worker && uv run pytest --cov=analytics_worker

# Run specific test
cd services/analytics-worker && uv run pytest tests/test_cli.py::test_cli_status
```

### Linting and Formatting

```bash
# Check code style
make lint-python

# Auto-format code
make format-python
```

## CI/CD Integration

### GitHub Actions

```yaml
- name: Install uv
  run: curl -LsSf https://astral.sh/uv/install.sh | sh

- name: Install dependencies
  run: cd services/analytics-worker && uv sync

- name: Run tests
  run: cd services/analytics-worker && uv run pytest
```

### Dockerfile

```dockerfile
FROM python:3.11-slim

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

WORKDIR /app

# Copy project files
COPY pyproject.toml .
COPY analytics_worker ./analytics_worker

# Install dependencies
RUN uv sync

# Run application
CMD ["uv", "run", "python", "-m", "analytics_worker"]
```

## Troubleshooting

### Issue: uv command not found

**Solution:**
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
# Add ~/.local/bin to PATH
```

### Issue: Dependencies not installing

**Solution:**
```bash
# Clear cache and reinstall
uv cache clean
uv sync --reinstall
```

### Issue: Python version mismatch

**Solution:**
```bash
# Check required Python version in pyproject.toml
cat pyproject.toml | grep "requires-python"

# Install specific Python version
uv python install 3.11
```

## Additional Resources

- [UV Documentation](https://github.com/astral-sh/uv)
- [PEP 518: pyproject.toml](https://peps.python.org/pep-0518/)
- [PEP 621: Project metadata](https://peps.python.org/pep-0621/)
- [Python Packaging User Guide](https://packaging.python.org/)
